import*as global from"./modules/global.js";import{consoleLog,loadCssFile,loadJsFile,exeJsCode,currentColorScheme,initDarkMode,initDarkModeEditor,autoDarkMode,sitecoreItemJson,getScItemData,startDrag}from"./modules/helpers.js";import{showSnackbar}from"./modules/snackbar.js";import{checkWorkbox}from"./modules/workbox.js";import{checkUrlStatus}from"./modules/url.js";import{resumeFromWhereYouLeftOff,historyNavigation}from"./modules/history.js";import{checkNotificationPermissions,sendNotification}from"./modules/notification.js";import{findCountryName}from"./modules/language.js";import{sitecoreAuthorToolbox,initCharsCount,initCheckboxes}from"./modules/contenteditor.js";import{initGravatarImage,initUserMenu}from"./modules/users.js";import{initInstantSearch,enhancedSitecoreSearch}from"./modules/search.js";import{insertModal,insertPanel}from"./modules/insert.js";import{initMediaExplorer,initMediaCounter,initMediaDragDrop,initMediaViewButtons}from"./modules/media.js";import{initExperimentalUi,insertSavebar,initInsertIcon,initGutter,initColorPicker,initSitecoreMenu,initContrastedIcons,initSvgAnimation,initEventListeners,initRteTooltips}from"./modules/experimentalui.js";import{initFavorites}from"./modules/favorites.js";import{initGroupedErrors}from"./modules/errors.js";import{insertPreviewButton,listenPreviewTab}from"./modules/preview.js";import{insertLaunchpadIcon,insertLaunchpadMenu}from"./modules/launchpad.js";chrome.storage.sync.get(storage=>{if(global.isSitecore&&!global.isEditMode&&!global.isLoginPage&&!global.isCss&&!global.isUploadManager){if(consoleLog("Content Editor detected","red"),document.body.classList.add("satExtension"),loadJsFile("js/inject.js"),checkNotificationPermissions(),initUserMenu(storage),initDarkMode(storage),autoDarkMode(storage),initExperimentalUi(storage),initContrastedIcons(storage),global.isContentEditor){if(consoleLog("**** Content Editor ****","yellow"),storage.feature_experimentalui){let ScItem=getScItemData();initSvgAnimation(),insertSavebar(),insertModal(ScItem.id,ScItem.language,ScItem.version),insertPanel(),initInsertIcon(),initGutter(),initColorPicker(),initSitecoreMenu(),initEventListeners()}initInstantSearch(storage),historyNavigation(),resumeFromWhereYouLeftOff(storage),initFavorites(storage),showSnackbar(),checkWorkbox(storage)}if((global.isDesktop&&!global.isGalleryFavorites&&!global.isXmlControl||global.isLaunchpad)&&(consoleLog("**** Launchpad - Desktop Shell ****","orange"),insertLaunchpadIcon(storage),insertLaunchpadMenu(storage),checkWorkbox(storage)),global.isSearch)consoleLog("**** Internal Search ****","orange"),enhancedSitecoreSearch();else if(global.isPreviewTab)consoleLog("**** Preview tab ****","orange"),insertPreviewButton(storage),listenPreviewTab(storage);else if(global.isDialog||global.isLockedItems)consoleLog("**** Dialog UI ****","orange");else if(global.isFieldEditor){consoleLog("**** Field editor ****","orange"),initCheckboxes(storage),initCharsCount(storage),initGroupedErrors(storage);var scBucketListSelectedBox=document.querySelectorAll(".scBucketListSelectedBox, .scContentControlMultilistBox"),Section_Data=document.querySelector("#Section_Data");(scBucketListSelectedBox=scBucketListSelectedBox[1]?scBucketListSelectedBox[1]:scBucketListSelectedBox[0])&&scBucketListSelectedBox.addEventListener("change",(function(){var itemId=scBucketListSelectedBox.value;itemId=itemId.includes("|")?itemId.split("|")[1]:itemId;var itemName=scBucketListSelectedBox[scBucketListSelectedBox.selectedIndex].text,scMessageEditText=`<a class="scMessageBarOption" href="${window.location.origin}/sitecore/shell/Applications/Content%20Editor.aspx?sc_bw=1#${itemId}" target="_blank"><u>Click here ⧉</u></a> `,scMessageEdit='<div id="Warnings" class="scMessageBar scWarning"><div class="scMessageBarIcon" style="background-image:url('+global.icon+')"></div><div class="scMessageBarTextContainer"><div class="scMessageBarTitle">'+itemName+"</div>";scMessageEdit+='<span id="Information" class="scMessageBarText"><span class="scMessageBarOptionBullet">'+scMessageEditText+"</span> to edit this datasource in <b>Content Editor</b>.</span>",scMessageEdit+="</div></div>",document.querySelector(".scMessageBar")?(document.querySelector(".scMessageBarTitle").innerHTML=itemName,document.querySelector(".scMessageBarOptionBullet").innerHTML=scMessageEditText):Section_Data.insertAdjacentHTML("beforebegin",scMessageEdit)}))}else if(global.isSourceBrowser)consoleLog("**** Source Browser ****","orange");else if(global.isMediaFolder)consoleLog("**** Media Folder ****","orange"),initMediaCounter(),initMediaDragDrop(),initMediaViewButtons(),initMediaExplorer(storage);else if(global.isExperienceProfile)consoleLog("**** Experience Profile ****","orange"),initGravatarImage(storage);else if(global.isRichTextEditor||global.isHtmlEditor){var contentIframe;if(consoleLog("**** Rich Text Editor ****","orange"),initRteTooltips(storage),null==storage.feature_rtecolor&&(storage.feature_rtecolor=!0),null==storage.feature_darkmode&&(storage.feature_darkmode=!1),null==storage.feature_darkmode_auto&&(storage.feature_darkmode_auto=!1),storage.feature_rtecolor)if(contentIframe=global.isRichTextEditor?document.querySelector("#Editor_contentIframe"):document.querySelector("#ctl00_ctl00_ctl05_Html")){let reTextArea=!!global.isRichTextEditor&&document.querySelector(".reTextArea");loadCssFile("css/codemirror.min.css");let darkModeTheme=initDarkModeEditor(storage);global.isRichTextEditor?(reTextArea.insertAdjacentHTML("afterend",'<input type="hidden" class="scDarkMode" value="'+darkModeTheme+'" />'),reTextArea.insertAdjacentHTML("afterend",'<input type="hidden" class="scEditor" value="richTextEditor" />')):global.isHtmlEditor&&(contentIframe.insertAdjacentHTML("afterend",'<input type="hidden" class="scDarkMode" value="'+darkModeTheme+'" />'),contentIframe.insertAdjacentHTML("afterend",'<input type="hidden" class="scEditor" value="htmlEditor" />')),loadJsFile("js/bundle.min.js")}}else if(global.isContentEditorApp&&storage.feature_experimentalui||global.isContentEditorApp&&storage.feature_instantsearch){let globalLogo=document.querySelector("#globalLogo");globalLogo&&globalLogo.setAttribute("target","_parent")}else if(global.isEditorFolder)consoleLog("**** Editors folder ****","orange");else if(global.isGalleryVersion)consoleLog("**** Versions menu ****","orange");else if(global.isGalleryLinks)consoleLog("**** Links menu ****","orange");else if(global.isLayoutDetails)consoleLog("**** Layout Details ****","orange"),document.querySelectorAll(".scRollOver").forEach((function(element){let attribute=element.getAttribute("onclick");attribute.substring(attribute.lastIndexOf("{")+1,attribute.lastIndexOf("}"))}));else if(global.isGalleryLanguage){if(consoleLog("**** Languages menu ****","orange"),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags){var dom=document.querySelector("#Languages"),div=dom.querySelectorAll(".scMenuPanelItem,.scMenuPanelItemSelected"),td,tdlanguage,tdversion,tdimage,temp,tdcount=0;(div=[].slice.call(div).sort((function(a,b){return a.querySelector("table > tbody > tr > td > div > div:last-child").textContent>b.querySelector("table > tbody > tr > td > div > div:last-child").textContent?-1:1}))).forEach((function(language){dom.appendChild(language)}));for(let item of div){tdcount=0,td=item.getElementsByTagName("td");for(let item2 of td){if(0==tdcount)tdimage=item2.getElementsByTagName("img");else{let rawVersion;tdlanguage=(tdlanguage=item2.getElementsByTagName("b"))[0].innerHTML,tdversion=(tdversion=(tdversion=item2.getElementsByTagName("div"))[2].innerHTML).split(" "),"fallback version"==item2.getElementsByTagName("div")[2].innerHTML.toLowerCase()?(temp=item2.getElementsByTagName("div"))[2].setAttribute("style","background-color: lime; display: initial; padding: 0px 3px; color: #000000 !important"):"0"!=tdversion[0]&&(temp=item2.getElementsByTagName("div"))[2].setAttribute("style","background-color: yellow; display: initial; padding: 0px 3px; color: #000000 !important"),tdlanguage=findCountryName(tdlanguage),tdimage[0].onerror=function(){this.src=global.iconFlagGeneric},tdimage[0].src=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/32x32/flag_"+tdlanguage+".png")}tdcount++}}}}else if(global.isPublishDialog){if(consoleLog("**** Publishing window ****","orange"),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags){let target=document.querySelector("body"),observer=new MutationObserver((function(){var tdlanguage,label=document.querySelectorAll("div[data-sc-id=CheckBoxListLanguages] > table:last-child")[0];if(null!=label&&label.children[0].children.length>1)for(var tr of label.children[0].children)for(var td of tr.children)if(tdlanguage=findCountryName(td.innerText.trim()),null==td.querySelector("#scFlag")){let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/16x16/flag_"+tdlanguage+".png");td.querySelector("label > span").insertAdjacentHTML("beforebegin",' <img loading="lazy" id="scFlag" src="'+flag+'" style="display: inline !important; vertical-align: middle; padding-right: 2px; width:16px;" onerror="this.onerror=null;this.src=\''+global.iconFlagGeneric+"';\"/>")}}));target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1,subtree:!0})}}else if(global.isPublishWindow){if(consoleLog("**** Publish / Rebuild / Package ****","orange"),initExperimentalUi(storage),!0===storage.feature_contenteditor&&(document.querySelectorAll("#PublishChildrenPane input[type=checkbox]").forEach((function(checkbox){checkbox.classList.add("scContentControlCheckbox");let labelHtml='<label for="'+checkbox.id+'" class="scContentControlCheckboxLabel"></label>';checkbox.insertAdjacentHTML("afterend",labelHtml)})),loadCssFile("css/checkbox.min.css")),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags){var label=document.querySelectorAll("#Languages > label");for(let item of label){tdlanguage=findCountryName(item.innerText.trim());let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/16x16/flag_"+tdlanguage+".png");item.insertAdjacentHTML("beforebegin",' <img loading="lazy" id="scFlag" src="'+flag+'" style="display: inline !important; vertical-align: middle; padding-right: 2px; width:16px" onerror="this.onerror=null;this.src=\''+global.iconFlagGeneric+"';\"/>")}}}else global.isXmlControl&&!global.isRichText&&(consoleLog("**** XML Control (Window) ****","orange"),initExperimentalUi(storage));null==storage.feature_autoexpand&&(storage.feature_autoexpand=!0),null==storage.feature_autoexpandcount&&(storage.feature_autoexpandcount=!1),storage.feature_autoexpand&&document.querySelector(".scContentTree")&&(document.querySelector(".scContentTree").addEventListener("click",(function(event){if(null!=event.target.offsetParent&&event.target.offsetParent.offsetParent.matches(".scContentTreeNodeNormal")&&(storage.feature_experimentalui&&document.querySelector("#svgAnimation").setAttribute("style","opacity:1"),storage.feature_experimentalui?document.querySelector("#EditorFrames").setAttribute("style","opacity:0"):document.querySelector("#EditorFrames").setAttribute("style","opacity:0.5"),document.querySelector(".scContentTreeContainer").setAttribute("style","opacity:0.5"),document.querySelectorAll(".scEditorTabHeaderNormal, .scEditorTabHeaderActive > span")[0].innerText=global.tabLoadingTitle,document.querySelector(".scPreviewButton")&&(document.querySelector(".scPreviewButton").innerText=global.tabLoadingTitle,document.querySelector(".scPreviewButton").disabled=!0),setTimeout((function(){document.querySelector("#svgAnimation")&&document.querySelector("#svgAnimation").setAttribute("style","opacity:0"),document.querySelector("#EditorFrames").setAttribute("style","opacity:1"),document.querySelector(".scContentTreeContainer").setAttribute("style","opacity:1")}),7e3)),event.target.matches(".scContentTreeNodeGlyph")){let glyphId=event.target.id;setTimeout((function(){if(document&&glyphId){let subTreeDiv=document.querySelector("#"+glyphId).nextSibling.nextSibling.nextSibling;if(subTreeDiv){let newNodes=subTreeDiv.querySelectorAll(".scContentTreeNode");1==newNodes.length&&newNodes[0].querySelector(".scContentTreeNodeGlyph").click(),storage.feature_autoexpandcount&&document.querySelectorAll(".scCountNodes").forEach((function(element){element.setAttribute("style","display:none")}))}else{let subTreeMain=document.querySelector("#"+glyphId).nextSibling.nextSibling;subTreeMain.querySelector(".scCountNodes")&&subTreeMain.querySelector(".scCountNodes").remove()}}}),200)}if(event.target.matches(".dynatree-expander")){let glyphId=event.path[1];setTimeout((function(){if(document&&glyphId){let subTreeDiv=glyphId.nextSibling;if(console.log(subTreeDiv),subTreeDiv){let newNodes=subTreeDiv.querySelectorAll(".dynatree-has-children");1==newNodes.length&&newNodes[0].querySelector(".dynatree-expander").click(),console.log(newNodes)}}}),200)}}),!1),document.addEventListener("mousedown",(function(event){if(!event.target.matches(".glyph"))return;let glyphId=event.target.id,glyphSrc,isCollapsed=event.target.src.includes("collapsed");setTimeout((function(){if(document&&glyphId&&isCollapsed){var subTreeDiv=document.querySelector("#"+glyphId).closest("ul").nextSibling,nextGlyphId;if(subTreeDiv)subTreeDiv.querySelector(".glyph").click()}}),200)}),!1)),setTimeout((function(){document.querySelectorAll(".scContentTreeNodeGutterIcon").forEach((function(el){let parent=el.parentElement;parent.setAttribute("data-tooltip",el.getAttribute("title")),parent.classList.add("t-right"),parent.classList.add("t-xs"),el.removeAttribute("title")}))}),2500);let target=document.querySelector("#LastPage"),observer=new MutationObserver((function(){if(null==storage.feature_notification&&(storage.feature_notification=!0),null==storage.feature_experimentalui&&(storage.feature_experimentalui=!1),storage.feature_notification){let darkMode;target=document.querySelector("#LastPage");var notificationSubTitle=target.querySelector(".sc-text-largevalue").innerHTML,notificationBody=target.querySelector(".scFieldLabel").innerHTML;"Result:"==notificationBody&&(notificationBody="Finished "+document.querySelector("#ResultText").value.split("Finished")[1]),sendNotification(notificationSubTitle,notificationBody),darkMode=!!(storage.feature_darkmode&&!storage.feature_darkmode_auto||storage.feature_darkmode&&storage.feature_darkmode_auto&&"dark"==currentColorScheme());var parentSelector=parent.parent.document.querySelector("body");checkUrlStatus(parentSelector.querySelector(".liveUrlStatus"),parentSelector,darkMode,storage.feature_experimentalui)}}));target&&observer.observe(target,{attributes:!0}),target=document.querySelector("#scLanguage"),observer=new MutationObserver((function(mutations){consoleLog("*** Update UI ***","yellow");var scQuickInfo=document.querySelector(".scEditorHeaderQuickInfoInput");if(scQuickInfo){var sitecoreItemID=scQuickInfo.getAttribute("value"),scLanguage=document.querySelector("#scLanguage").getAttribute("value").toLowerCase();let scVersion=document.querySelector(".scEditorHeaderVersionsVersion > span");scVersion=null!=scVersion?scVersion.innerText:1;var locaStorage=localStorage.getItem("scBackPrevious");if(!global.hasRedirection&&!global.hasRedirectionOther&&!global.hasModePreview)if("true"!=locaStorage){var state={sitecore:!0,id:sitecoreItemID,language:scLanguage,version:scVersion};history.pushState(state,void 0,"#"+sitecoreItemID+"_"+scLanguage+"_"+scVersion)}else localStorage.removeItem("scBackPrevious")}setTimeout(()=>{document.querySelectorAll("#EditorTabControls_Preview").forEach(elem=>{elem.remove()})},500),mutations.forEach((function(e){"attributes"==e.type&&sitecoreAuthorToolbox()}))})),target&&observer.observe(target,{attributes:!0})}if(global.isEditMode&&!global.isLoginPage||global.isPreviewMode&&!global.isLoginPage){consoleLog("Experience Editor detected","red"),document.body.classList.add("loaded"),loadJsFile("js/inject.js");let dataItemId=document.querySelector("[data-sc-itemid]"),dataItemLanguage=document.querySelector("[data-sc-language]"),dataItemVersion=document.querySelector("[data-sc-version]");if(dataItemId&&dataItemVersion){var sitecoreItemID=decodeURI(dataItemId.getAttribute("data-sc-itemid")),scLanguage=decodeURI(dataItemLanguage.getAttribute("data-sc-language")),scVersion=decodeURI(dataItemVersion.getAttribute("data-sc-version"));sitecoreItemJson(sitecoreItemID,scLanguage,scVersion)}if(global.isGalleryLanguageExpEd&&(consoleLog("**** Languages menu ****","yellow"),initExperimentalUi(storage),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags)){var tdDiv;div=(dom=document.querySelector(".sc-gallery-content")).querySelectorAll("a[data-sc-argument]"),tdcount=0,(div=[].slice.call(div).sort((function(a,b){return a.querySelector("a > div > div:last-child > span").textContent>b.querySelector("a > div > div:last-child > span").textContent?-1:1}))).forEach((function(language){dom.appendChild(language)}));for(let item of div){tdDiv=item.querySelector(".sc-gallery-option-content,.sc-gallery-option-content-active"),tdlanguage=item.querySelector(".sc-gallery-option-content-header > span").innerText,"0"!=(temp=(tdversion=item.querySelector(".sc-gallery-option-content-description > span")).innerHTML.split(" "))[0]&&tdversion.setAttribute("style","background-color: yellow; display: initial; padding: 0px 3px; color: #000000 !important"),tdlanguage=findCountryName(tdlanguage);let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/32x32/flag_"+tdlanguage+".png");tdDiv.setAttribute("style","padding-left:48px; background-image: url("+flag+"); background-repeat: no-repeat; background-position: 5px; background-size: 32px")}}if(global.isRibbon){consoleLog("**** Ribbon ****","yellow");let scRibbonFlagIcons=document.querySelector(".flag_generic_24");if(scRibbonFlagIcons&&(tdlanguage=scRibbonFlagIcons.nextSibling.innerText),tdlanguage){tdlanguage=findCountryName(tdlanguage);let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/24x24/flag_"+tdlanguage+".png");scRibbonFlagIcons.setAttribute("style","background-image: url("+flag+"); background-repeat: no-repeat; background-position: top left;")}}let target=document.querySelector(".scChromeDropDown"),observer=new MutationObserver((function(){let scChromeDropDownRow=document.querySelectorAll(".scChromeDropDownRow"),scLanguage=document.querySelector("#scLanguage").value,scVersion="";for(var row of scChromeDropDownRow)if("change associated content"==row.getAttribute("title").toLowerCase()){var id,html='<a href="#" title="Edit in Content Editor" class="scChromeDropDownRow" onclick="javascript:window.open(\'/sitecore/shell/Applications/Content%20Editor.aspx?sc_bw=1#{'+row.getAttribute("onclick").split("id={")[1].split("}")[0]+"}_"+scLanguage.toLowerCase()+'_\')"><img src="/~/icon/applicationsv2/32x32/window_edit.png" style="width:16px" alt="Edit in Content Editor"><span>Edit in Content Editor</span></a>';row.insertAdjacentHTML("beforebegin",html)}}));target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1}),global.isRibbon||global.isModalDialogs||(target=document.querySelector("body"),observer=new MutationObserver((function(mutation){mutation.forEach((function(el){if(el.addedNodes[0]){var node=el.addedNodes[0],title;"scInsertionHandle"==el.addedNodes[0].className?(title=node.getAttribute("title").toLowerCase().split("'")[1].split("'")[0],node.insertAdjacentHTML("beforeend","<span class='scAddRendering'>Add component here</span>"),null!=title&&""!=title&&(node.setAttribute("data-tooltip","Placeholder: "+title),node.classList.add("t-top"),node.classList.add("t-md"),node.removeAttribute("title"))):el.addedNodes[0]&&"scSortingHandle"==el.addedNodes[0].className&&(title=node.getAttribute("title").toLowerCase().split("'")[1].split("'")[0],node.insertAdjacentHTML("beforeend","<span class='scAddRendering'>Move component here</span>"),null!=title&&""!=title&&(node.setAttribute("data-tooltip","Placeholder: "+title),node.classList.add("t-top"),node.classList.add("t-md"),node.removeAttribute("title")))}}))})),target&&observer.observe(target,{childList:!0})),target=document.querySelector(".scChromeControls"),observer=new MutationObserver((function(){var scChromeToolbar=document.querySelectorAll(".scChromeToolbar");for(var controls of scChromeToolbar){controls.setAttribute("style","margin-left:50px");var scChromeCommand=controls.querySelectorAll(".scChromeCommand"),changeColor=!1;for(var command of scChromeCommand){var title=command.getAttribute("title");command.setAttribute("style","z-index:auto"),!changeColor&&title&&(title.toLowerCase().includes("move component")||title.toLowerCase().includes("remove component")?(document.querySelectorAll(".scFrameSideHorizontal, .scFrameSideVertical").forEach((function(e){e.classList.remove("scFrameYellow")})),changeColor=!0):document.querySelectorAll(".scFrameSideHorizontal, .scFrameSideVertical").forEach((function(e){e.classList.add("scFrameYellow")}))),null!=title&&""!=title&&(command.setAttribute("data-tooltip",title),command.classList.add("t-bottom"),command.classList.add("t-md"),command.removeAttribute("title"))}}})),target&&observer.observe(target,{attributes:!0,childList:!0,characterData:!0});var pagemodeEdit=document.querySelector(".pagemode-edit");let tabColor;var linkNormalMode;if(!pagemodeEdit&&(pagemodeEdit=document.querySelector(".on-page-editor")),!pagemodeEdit&&(pagemodeEdit=document.querySelector(".experience-editor")),!pagemodeEdit&&(pagemodeEdit=document.querySelector(".scWebEditRibbon")),null==storage.feature_darkmode&&(storage.feature_darkmode=!1),null==storage.feature_darkmode_auto&&(storage.feature_darkmode_auto=!1),null==storage.feature_experienceeditor&&(storage.feature_experienceeditor=!0),storage.feature_experienceeditor&&loadCssFile("css/reset.min.css"),(storage.feature_darkmode&&!storage.feature_darkmode_auto&&global.isRibbon||storage.feature_darkmode&&!storage.feature_darkmode_auto&&global.isDialogConfirm||storage.feature_darkmode&&!storage.feature_darkmode_auto&&global.isInsertPage||storage.feature_darkmode&&storage.feature_darkmode_auto&&global.isRibbon&&"dark"==currentColorScheme()||storage.feature_darkmode&&storage.feature_darkmode_auto&&global.isDialogConfirm&&"dark"==currentColorScheme()||storage.feature_darkmode&&storage.feature_darkmode_auto&&global.isInsertPage&&"dark"==currentColorScheme())&&document.body.classList.add("satDark"),(storage.feature_darkmode&&!storage.feature_darkmode_auto||storage.feature_darkmode&&storage.feature_darkmode_auto&&"dark"==currentColorScheme())&&(tabColor="dark"),target=document.body,observer=new MutationObserver((function(mutations){for(var mutation of mutations)for(var addedNode of mutation.addedNodes)if("scCrossPiece"==addedNode.id){var html='<div class="scExpTab '+tabColor+'">\n                        <span class="tabHandle"></span>\n                        <span class="tabText" onclick="toggleRibbon()">▲ Hide<span>\n                        </div>';addedNode.insertAdjacentHTML("afterend",html),observer.disconnect(),startDrag(),document.addEventListener("keydown",event=>{"Shift"===event.key&&(exeJsCode("toggleRibbon()"),event.preventDefault(),event.stopPropagation())})}})),storage.feature_experienceeditor&&target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1}),linkNormalMode=global.isEditMode?global.windowLocationHref.replace("sc_mode=edit","sc_mode=normal"):global.isPreviewMode?global.windowLocationHref.replace("sc_mode=preview","sc_mode=normal"):global.windowLocationHref.includes("?")?global.windowLocationHref+"&sc_mode=normal":global.windowLocationHref+"?sc_mode=normal",storage.feature_experienceeditor&&!global.isRibbon){let html='<div class="scNormalModeTab '+tabColor+'"><span class="t-right t-sm" data-tooltip="Open in Normal Mode"><a href="'+linkNormalMode+'" target="_blank"><img loading="lazy" src="'+global.iconChrome+'"/></a></span></div>';pagemodeEdit&&pagemodeEdit.insertAdjacentHTML("afterend",html)}if(storage.feature_experienceeditor&&!global.isRibbon){let html='<div class="scContentEditorTab '+tabColor+'"><span class="t-right t-sm" data-tooltip="Open in Content Editor"><a href="'+window.location.origin+'/sitecore/shell/Applications/Content%20Editor.aspx?sc_bw=1"><img loading="lazy" src="'+global.iconCE+'"/></a></span></div>';pagemodeEdit&&pagemodeEdit.insertAdjacentHTML("afterend",html)}if(storage.feature_experienceeditor&&!global.isRibbon){let html='<div class="scEditableTab '+tabColor+'"><span class="t-right t-sm" data-tooltip="Show/hide editable content"><a onclick="showEditableContent()"><img loading="lazy" src="'+global.iconED+'" id="scEditableImg" class="grayscaleClass"/></a></span></div>';pagemodeEdit&&pagemodeEdit.insertAdjacentHTML("afterend",html)}}});